<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel Admin - Músicas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f6f8;
      color: #333;
    }
    h1, h2 {
      color: #444;
    }
    form {
      margin-bottom: 20px;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    input, textarea, button {
      margin: 5px 0;
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
    }
    .list-item {
      background: #fff;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    /* Estilo IP */
    .log-ip {
      font-family: monospace;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      cursor: pointer;
      user-select: text;
      transition: background 0.2s ease;
    }
    .log-ip.ipv4 {
      background: #e9f0ff;
      color: #1a237e;
    }
    .log-ip.ipv6 {
      background: #eafaea;
      color: #1b5e20;
    }
    .log-ip:hover {
      background: #d0d8ff;
    }
    .log-ip svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }
    progress {
      height: 16px;
      border-radius: 8px;
      overflow: hidden;
    }
    audio {
      margin-top: 5px;
      width: 100%;
    }
  </style>
</head>
<body>

  <h1>Painel Administrativo</h1>

  <div id="loginArea">
    <form id="loginForm">
      <h2>Login</h2>
      <input type="text" id="usuario" placeholder="Usuário" required />
      <input type="password" id="senha" placeholder="Senha" required />
      <button type="submit">Entrar</button>
    </form>
  </div>

  <div id="adminArea" style="display:none;">
    <button onclick="logout()">Sair</button>

    <h2 id="formTitle">Cadastrar Música</h2>
    <form id="musicaForm">
      <input type="hidden" id="musicaId" />
      <input type="date" id="data" required />
      <input type="number" id="posicao" placeholder="Posição (opcional)" />
      <input type="text" id="titulo" placeholder="Título" required />

      <input type="text" id="audioUrlInput" placeholder="URL do áudio" />
      <div style="display:flex;flex-direction:column;gap:6px;width:150px">
        <input id="audioFile" type="file" accept="audio/*" />
        <button id="uploadBtn" type="button">Fazer upload</button>
        <progress id="uploadProgress" value="0" max="100" style="width:100%;display:none"></progress>
      </div>

      <input type="text" id="capa" placeholder="URL da capa" />
      <textarea id="letra" placeholder="Letra"></textarea>
      <button type="submit" id="salvarBtn">Salvar</button>
    </form>

    <h2>Lista de Músicas</h2>
    <div id="listaMusicas"></div>

    <h2>Logs de Acesso</h2>
    <div id="listaLogs"></div>
  </div>

  <script>
    const loginForm = document.getElementById("loginForm");
    const musicaForm = document.getElementById("musicaForm");
    const listaMusicas = document.getElementById("listaMusicas");
    const listaLogs = document.getElementById("listaLogs");
    const audioUrlInput = document.getElementById("audioUrlInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadProgress = document.getElementById("uploadProgress");

    // Login
    loginForm.onsubmit = async (e) => {
      e.preventDefault();
      const res = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ usuario: usuario.value, senha: senha.value })
      });
      if (res.ok) {
        loginArea.style.display = "none";
        adminArea.style.display = "block";
        carregarMusicas();
        carregarLogs();
      } else {
        alert("Login inválido");
      }
    };

    function logout() {
      fetch("/api/logout", { method: "POST" });
      location.reload();
    }

    // Upload com progresso
    uploadBtn.onclick = () => {
      if (!audioFile.files || audioFile.files.length === 0) {
        alert("Selecione um arquivo primeiro");
        return;
      }
      const file = audioFile.files[0];
      const fd = new FormData();
      fd.append("audio", file);

      const xhr = new XMLHttpRequest();
      xhr.open("POST", "/api/upload", true);

      uploadBtn.disabled = true;
      uploadBtn.textContent = "Enviando...";
      uploadProgress.style.display = "block";
      uploadProgress.value = 0;

      xhr.upload.onprogress = (event) => {
        if (event.lengthComputable) {
          const percent = Math.round((event.loaded / event.total) * 100);
          uploadProgress.value = percent;
          uploadBtn.textContent = `Enviando... ${percent}%`;
        }
      };

      xhr.onload = () => {
        uploadBtn.disabled = false;
        uploadBtn.textContent = "Fazer upload";
        uploadProgress.style.display = "none";
        try {
          const res = JSON.parse(xhr.responseText);
          if (xhr.status === 200) {
            audioUrlInput.value = res.url;
            alert("Upload feito! URL preenchida.");
          } else {
            alert(res?.error || "Erro no upload");
          }
        } catch {
          alert("Erro no upload");
        }
      };

      xhr.onerror = () => {
        uploadBtn.disabled = false;
        uploadBtn.textContent = "Fazer upload";
        uploadProgress.style.display = "none";
        alert("Erro na conexão durante o upload.");
      };

      xhr.send(fd);
    };

    // Salvar/editar música
    musicaForm.onsubmit = async (e) => {
      e.preventDefault();
      const id = musicaId.value;
      const payload = {
        data: data.value,
        posicao: posicao.value,
        titulo: titulo.value,
        audio: audioUrlInput.value,
        capa: capa.value,
        letra: letra.value
      };
      const url = id ? `/api/musicas/${id}` : "/api/musicas";
      const method = id ? "PUT" : "POST";
      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        musicaForm.reset();
        musicaId.value = "";
        formTitle.textContent = "Cadastrar Música";
        salvarBtn.textContent = "Salvar";
        carregarMusicas();
      } else {
        alert("Erro ao salvar música");
      }
    };

    async function carregarMusicas() {
      const res = await fetch("/api/admin/musicas");
      if (!res.ok) return;
      const data = await res.json();
      listaMusicas.innerHTML = data.map(r => `
        <div class="list-item">
          <strong>${r.data}</strong> - ${r.titulo}<br/>
          <audio controls src="${r.audio}"></audio><br/>
          <button onclick='editarMusica(${JSON.stringify(r)})'>Editar</button>
          <button onclick='deletarMusica(${r.id})'>Excluir</button>
        </div>
      `).join("");
    }

    function editarMusica(r) {
      musicaId.value = r.id;
      data.value = r.data;
      posicao.value = r.posicao || "";
      titulo.value = r.titulo;
      audioUrlInput.value = r.audio;
      capa.value = r.capa || "";
      letra.value = r.letra || "";
      formTitle.textContent = "Editar Música";
      salvarBtn.textContent = "Atualizar";
    }

    async function deletarMusica(id) {
      if (!confirm("Excluir música?")) return;
      const res = await fetch(`/api/musicas/${id}`, { method: "DELETE" });
      if (res.ok) carregarMusicas();
    }

    // Funções IP e logs
    function getIPClass(ip) {
      return ip.includes(":") ? "ipv6" : "ipv4";
    }

    async function copiarIP(ip) {
      try {
        await navigator.clipboard.writeText(ip);
        alert("IP copiado: " + ip);
      } catch {
        alert("Não foi possível copiar.");
      }
    }

    function agruparPorIP(logs) {
      const mapa = {};
      logs.forEach(log => {
        if (!mapa[log.ip]) {
          mapa[log.ip] = [];
        }
        mapa[log.ip].push(log);
      });
      return mapa;
    }

    async function carregarLogs() {
      const res = await fetch("/api/admin/logs");
      if (!res.ok) return;
      const rows = await res.json();

      const agrupado = agruparPorIP(rows);

      listaLogs.innerHTML = Object.entries(agrupado).map(([ip, acessos]) => {
        const ipClass = getIPClass(ip);
        const total = acessos.length;
        return `
          <div class="list-item">
            <div class="log-ip ${ipClass}" onclick="toggleHoras('${ip.replace(/:/g,'-')}')" title="Clique para ver horários">
              <svg viewBox="0 0 24 24">
                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/>
              </svg>
              ${ip} — ${total} acesso${total>1?'s':''}
            </div>
            <div id="horas-${ip.replace(/:/g,'-')}" style="display:none;margin-top:6px;padding-left:24px;font-family:monospace">
              ${acessos.map(a => new Date(a.accessed_at).toLocaleTimeString("pt-BR")).join("<br/>")}
            </div>
          </div>
        `;
      }).join("");
    }

    function toggleHoras(id) {
      const el = document.getElementById("horas-" + id);
      if (!el) return;
      el.style.display = el.style.display === "none" ? "block" : "none";
    }
  </script>
</body>
</html>
