<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <title>Painel Admin - Calend√°rio</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      padding: 20px;
      background: #f4f6fb;
      margin: 0;
    }
    .card {
      background: #fff;
      padding: 18px;
      border-radius: 8px;
      max-width: 900px;
      margin: 20px auto;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }
    input, textarea, select {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      background: #4b6cff;
      color: #fff;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #3a54d6;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .top {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .row {
      display: flex;
      gap: 8px;
    }
    .small {
      width: 120px;
    }
    .list-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      font-size: 16px;
    }
    .danger {
      background: #ff6b6b;
    }
    .back-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: linear-gradient(135deg, #5a4dff, #7a69ff);
      color: #e0e0ff;
      padding: 10px 16px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(90, 77, 255, 0.6);
      z-index: 1000;
      transition: box-shadow 0.3s ease, transform 0.15s ease;
      user-select: none;
    }
    .back-btn:hover {
      background: linear-gradient(135deg, #7a69ff, #5a4dff);
      box-shadow: 0 6px 20px rgba(122, 105, 255, 0.8);
      transform: scale(1.05);
    }
    .back-btn:focus {
      outline: 2px solid #a29bff;
      outline-offset: 3px;
      box-shadow: 0 0 10px #a29bff;
    }
    /* Mobile Responsivo */
    @media (max-width: 600px) {
      body {
        padding: 12px 10px;
      }
      .card {
        padding: 14px 12px;
        margin: 12px 8px;
        max-width: 100%;
      }
      .grid {
        grid-template-columns: 1fr;
      }
      input, textarea, select {
        font-size: 14px;
      }
      button {
        font-size: 14px;
        padding: 10px 12px;
      }
      .top {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      .list-item {
        padding: 8px 6px;
        font-size: 14px;
      }
      .back-btn {
        top: 12px;
        left: 12px;
        padding: 8px 12px;
        font-size: 13px;
      }
      #musicForm > div[style*="display:flex"][style*="gap:8px"] {
        flex-direction: column;
      }
      #musicForm > div[style*="display:flex"][style*="gap:6px"] {
        flex-direction: row;
        gap: 6px;
      }
      #musicForm > div[style*="display:flex"][style*="gap:8px"]:last-child {
        flex-wrap: wrap;
      }
      #musicForm > div[style*="display:flex"][style*="gap:8px"]:last-child > button {
        flex: 1 1 100%;
        margin-bottom: 8px;
      }
    }

    /* Logs estilos */
    #listaLogs {
      max-width: 900px;
      margin-top: 24px;
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 0 14px #00000011;
    }
    .log-item {
      border-bottom: 1px solid #eee;
      padding: 12px 0;
      font-size: 15px;
      color: #444;
    }
    .log-item:last-child {
      border-bottom: none;
    }
    .log-ip {
      font-weight: 600;
      color: #2a2a2a;
    }
    .log-date {
      color: #666;
      font-size: 13px;
    }
    .log-useragent {
      font-style: italic;
      color: #555;
    }
    .pagination {
      text-align: center;
      margin-top: 14px;
    }
    .pagination button {
      background: #4b6cff;
      color: white;
      border: none;
      margin: 0 5px;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s ease;
    }
    .pagination button:disabled {
      background: #aab8ff88;
      cursor: default;
    }
    .pagination button:hover:not(:disabled) {
      background: #3a54d6;
    }
  </style>
</head>
<body>
  <button class="back-btn" onclick="window.location.href='/'">‚¨Ö Voltar</button>

  <div class="card">
    <div class="top">
      <h2>Painel Admin</h2>
      <div>
        <button id="logoutBtn" style="display:none">Sair</button>
      </div>
    </div>

    <div id="loginArea">
      <h3>Login</h3>
      <form id="loginForm">
        <input name="username" placeholder="Usu√°rio (ex: admin)" required/>
        <input name="password" placeholder="Senha" type="password" required/>
        <button type="submit">Entrar</button>
      </form>
    </div>

    <div id="adminArea" style="display:none">
      <h3>Adicionar / Editar M√∫sica</h3>
      <form id="musicForm">
        <div class="grid">
          <div>
            <label>Data (AAAA-MM-DD)</label>
            <input name="data" placeholder="2025-08-06" required/>
          </div>
          <div>
            <label>Posi√ß√£o (opcional ‚Äî deixar vazio para adicionar ao final)</label>
            <input name="posicao" placeholder="1, 2, ..." />
          </div>
        </div>

        <input name="titulo" placeholder="T√≠tulo da m√∫sica"/>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="audioUrl" name="audio" placeholder="URL do arquivo .mp3 (ou fa√ßa upload abaixo)" />
          <div style="display:flex;flex-direction:column;gap:6px">
            <input id="audioFile" type="file" accept="audio/*" />
            <button id="uploadBtn" type="button">Fazer upload</button>
          </div>
        </div>

        <input name="capa" placeholder="URL da capa (opcional)"/>
        <textarea name="letra" rows="6" placeholder="Letra (opcional)"></textarea>
        <div style="display:flex;gap:8px">
          <button type="submit">Salvar</button>
          <button id="previewBtn" type="button">Preview (abrir m√∫sica)</button>
        </div>
      </form>

      <hr/>
      <h4>M√∫sicas existentes</h4>
      <div id="listaMusicas"></div>

      <hr/>
      <h4>√öltimos acessos</h4>
      <div id="listaLogs">Carregando logs...</div>
      <div class="pagination" id="paginacao"></div>
    </div>
  </div>

  <script>
    // Elementos
    const loginForm = document.getElementById("loginForm");
    const loginArea = document.getElementById("loginArea");
    const adminArea = document.getElementById("adminArea");
    const logoutBtn = document.getElementById("logoutBtn");

    const musicForm = document.getElementById("musicForm");
    const listaMusicas = document.getElementById("listaMusicas");
    const previewBtn = document.getElementById("previewBtn");
    const audioUrlInput = document.getElementById("audioUrl");
    const audioFileInput = document.getElementById("audioFile");
    const uploadBtn = document.getElementById("uploadBtn");

    // Logs
    const listaLogs = document.getElementById("listaLogs");
    const paginacaoDiv = document.getElementById("paginacao");

    // Estado global
    let musics = [];
    let logs = [];
    let paginaAtual = 1;
    const logsPorPagina = 10;

    // Login simples (na API /api/admin/login)
    loginForm.onsubmit = async (e) => {
      e.preventDefault();
      const data = new FormData(loginForm);
      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          body: data
        });
        if (!res.ok) throw new Error("Login falhou");
        alert("Login bem-sucedido!");
        loginArea.style.display = "none";
        adminArea.style.display = "block";
        logoutBtn.style.display = "inline-block";
        carregarMusicas();
        carregarLogs();
      } catch (err) {
        alert("Erro no login: " + err.message);
      }
    };

    logoutBtn.onclick = async () => {
      try {
        const res = await fetch('/api/admin/logout', { method: 'POST' });
        if (!res.ok) throw new Error("Logout falhou");
        alert("Voc√™ saiu");
        loginArea.style.display = "block";
        adminArea.style.display = "none";
        logoutBtn.style.display = "none";
        musics = [];
        logs = [];
        listaMusicas.innerHTML = "";
        listaLogs.innerHTML = "";
        paginacaoDiv.innerHTML = "";
      } catch {
        alert("Erro no logout");
      }
    };

    // Carregar m√∫sicas do backend
    async function carregarMusicas() {
      listaMusicas.innerHTML = "Carregando m√∫sicas...";
      try {
        const res = await fetch('/api/admin/music');
        if (!res.ok) throw new Error("Falha ao carregar m√∫sicas");
        musics = await res.json();
        mostrarMusicas();
      } catch (err) {
        listaMusicas.innerHTML = "Erro: " + err.message;
      }
    }

    // Mostrar m√∫sicas na lista
    function mostrarMusicas() {
      if (musics.length === 0) {
        listaMusicas.innerHTML = "<p>Nenhuma m√∫sica cadastrada.</p>";
        return;
      }
      const html = musics.map((m, i) => `
        <div class="list-item" style="display:flex;justify-content:space-between;align-items:center;">
          <div style="flex:1;">
            <strong>${m.data || ''} ‚Äî ${m.titulo || 'Sem t√≠tulo'}</strong><br/>
            <small>${m.audio ? `<a href="${m.audio}" target="_blank">√Åudio</a>` : "Sem √°udio"}</small>
          </div>
          <div style="flex-shrink:0;">
            <button onclick="editarMusica(${i})" title="Editar">‚úèÔ∏è</button>
            <button onclick="deletarMusica(${i})" class="danger" title="Excluir">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
      listaMusicas.innerHTML = html;
    }

    // Editar m√∫sica
    window.editarMusica = (index) => {
      const m = musics[index];
      musicForm.data.value = m.data || "";
      musicForm.posicao.value = index + 1;
      musicForm.titulo.value = m.titulo || "";
      musicForm.audio.value = m.audio || "";
      musicForm.capa.value = m.capa || "";
      musicForm.letra.value = m.letra || "";
      window.scrollTo({top:0, behavior:"smooth"});
    };

    // Deletar m√∫sica
    window.deletarMusica = async (index) => {
      if (!confirm("Confirma excluir essa m√∫sica?")) return;
      try {
        const res = await fetch(`/api/admin/music/${index}`, { method: "DELETE" });
        if (!res.ok) throw new Error("Falha ao deletar m√∫sica");
        alert("M√∫sica deletada");
        carregarMusicas();
      } catch (err) {
        alert("Erro ao deletar: " + err.message);
      }
    };

    // Upload de √°udio para o servidor (se dispon√≠vel)
    uploadBtn.onclick = async () => {
      if (!audioFileInput.files.length) {
        alert("Selecione um arquivo de √°udio para upload");
        return;
      }
      const arquivo = audioFileInput.files[0];
      const form = new FormData();
      form.append("audio", arquivo);
      try {
        uploadBtn.disabled = true;
        uploadBtn.textContent = "Enviando...";
        const res = await fetch("/api/admin/upload", { method: "POST", body: form });
        if (!res.ok) throw new Error("Upload falhou");
        const json = await res.json();
        audioUrlInput.value = json.url || "";
        alert("Upload conclu√≠do!");
      } catch (err) {
        alert("Erro no upload: " + err.message);
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = "Fazer upload";
      }
    };

    // Salvar m√∫sica (adicionar ou atualizar)
    musicForm.onsubmit = async (e) => {
      e.preventDefault();
      const formData = new FormData(musicForm);
      const dataEnviar = {
        data: formData.get("data"),
        titulo: formData.get("titulo"),
        audio: formData.get("audio"),
        capa: formData.get("capa"),
        letra: formData.get("letra")
      };
      const posicaoStr = formData.get("posicao");
      let url = "/api/admin/music";
      let method = "POST";

      // Se posi√ß√£o preenchida, vai ser PUT para atualizar a m√∫sica na posi√ß√£o (index)
      if (posicaoStr) {
        const pos = parseInt(posicaoStr);
        if (!isNaN(pos) && pos > 0 && pos <= musics.length) {
          url = `/api/admin/music/${pos - 1}`;
          method = "PUT";
        }
      }

      try {
        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dataEnviar)
        });
        if (!res.ok) throw new Error("Falha ao salvar m√∫sica");
        alert("M√∫sica salva com sucesso!");
        musicForm.reset();
        carregarMusicas();
      } catch (err) {
        alert("Erro ao salvar: " + err.message);
      }
    };

    // Preview da m√∫sica no player externo (abre em nova aba)
    previewBtn.onclick = () => {
      const url = audioUrlInput.value.trim();
      if (!url) {
        alert("Informe a URL do √°udio para preview.");
        return;
      }
      window.open(url, "_blank");
    };

    // --- LOGS ---

    // Fun√ß√£o para formatar data leg√≠vel
    function formatarDataHora(isoStr) {
      const dt = new Date(isoStr);
      return dt.toLocaleString("pt-BR", { dateStyle: "short", timeStyle: "medium" });
    }

    // Simplifica user agent para navegador e SO b√°sicos
    function resumirUserAgent(ua) {
      let navegador = "Desconhecido";
      if (/Chrome/.test(ua)) navegador = "Chrome";
      else if (/Firefox/.test(ua)) navegador = "Firefox";
      else if (/Safari/.test(ua) && !/Chrome/.test(ua)) navegador = "Safari";
      else if (/Edge/.test(ua)) navegador = "Edge";
      else if (/Opera/.test(ua)) navegador = "Opera";
      else if (/MSIE|Trident/.test(ua)) navegador = "Internet Explorer";

      let so = "Desconhecido";
      if (/Windows NT 10/.test(ua)) so = "Windows 10";
      else if (/Windows NT 6\.1/.test(ua)) so = "Windows 7";
      else if (/Macintosh/.test(ua)) so = "Mac OS";
      else if (/Linux/.test(ua)) so = "Linux";
      else if (/Android/.test(ua)) so = "Android";
      else if (/iPhone/.test(ua)) so = "iOS";

      return navegador + " / " + so;
    }

    // Pega o primeiro IP (se vier com m√∫ltiplos)
    function limparIP(ipString) {
      return ipString ? ipString.split(",")[0].trim() : "";
    }

    // Busca localiza√ß√£o da IP via ip-api.com, retorna string ou vazio
    async function buscarLocalizacao(ip) {
      if (!ip) return "";
      try {
        const resp = await fetch(`https://ip-api.com/json/${ip}?lang=pt`);
        if (!resp.ok) return "";
        const json = await resp.json();
        if (json.status === "success") {
          let local = [json.city, json.regionName, json.country].filter(Boolean).join(", ");
          return local;
        }
      } catch {
        return "";
      }
      return "";
    }

    // Exibe logs da p√°gina atual
    async function mostrarPagina(pagina) {
      listaLogs.innerHTML = "Carregando...";

      paginaAtual = pagina;
      const start = (pagina - 1) * logsPorPagina;
      const end = start + logsPorPagina;
      const logsPagina = logs.slice(start, end);

      // Para cada log, pega localiza√ß√£o e monta HTML
      const itemsHTML = await Promise.all(
        logsPagina.map(async (log) => {
          const ipLimpo = limparIP(log.ip);
          const localizacao = await buscarLocalizacao(ipLimpo);
          const dataFormatada = formatarDataHora(log.accessed_at);
          const uaResumido = resumirUserAgent(log.user_agent);

          return `
            <div class="log-item">
              <div class="log-date">${dataFormatada}</div>
              <div class="log-ip">IP: ${ipLimpo}${localizacao ? " ‚Äî " + localizacao : ""}</div>
              <div class="log-useragent">${uaResumido}</div>
            </div>
          `;
        })
      );

      listaLogs.innerHTML = itemsHTML.join("") || "Nenhum log encontrado.";
      montarPaginacao();
    }

    // Monta bot√µes de pagina√ß√£o
    function montarPaginacao() {
      const totalPaginas = Math.ceil(logs.length / logsPorPagina);
      if (totalPaginas <= 1) {
        paginacaoDiv.innerHTML = "";
        return;
      }
      let html = "";

      html += `<button ${paginaAtual === 1 ? "disabled" : ""} onclick="mostrarPagina(${paginaAtual - 1})">‚¨Ö Anterior</button>`;
      html += `<span style="margin: 0 10px; font-weight: bold;">P√°gina ${paginaAtual} de ${totalPaginas}</span>`;
      html += `<button ${paginaAtual === totalPaginas ? "disabled" : ""} onclick="mostrarPagina(${paginaAtual + 1})">Pr√≥ximo ‚û°</button>`;

      paginacaoDiv.innerHTML = html;
    }

    // Carrega logs da API
    async function carregarLogs() {
      listaLogs.innerHTML = "Carregando logs...";
      try {
        const res = await fetch("/api/admin/logs");
        if (!res.ok) throw new Error("Erro ao carregar logs");
        logs = await res.json();
        mostrarPagina(1);
      } catch (e) {
        listaLogs.innerHTML = "Falha ao carregar logs: " + e.message;
        paginacaoDiv.innerHTML = "";
      }
    }

    // Inicializa - verifica se j√° est√° logado para mostrar o painel direto
    async function init() {
      try {
        const res = await fetch("/api/admin/auth-status");
        if (res.ok) {
          loginArea.style.display = "none";
          adminArea.style.display = "block";
          logoutBtn.style.display = "inline-block";
          carregarMusicas();
          carregarLogs();
        } else {
          loginArea.style.display = "block";
          adminArea.style.display = "none";
          logoutBtn.style.display = "none";
        }
      } catch {
        loginArea.style.display = "block";
        adminArea.style.display = "none";
        logoutBtn.style.display = "none";
      }
    }

    init();

    // Expor fun√ß√µes para acesso global para edi√ß√£o/deletar logs
    window.editarMusica = window.editarMusica;
    window.deletarMusica = window.deletarMusica;
    window.mostrarPagina = mostrarPagina;
  </script>
</body>
</html>
