<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <title>Painel Admin - Calendário</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      padding: 20px;
      background: #f4f6fb;
      margin: 0;
    }

    .card {
      background: #fff;
      padding: 18px;
      border-radius: 8px;
      max-width: 900px;
      margin: 20px auto;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    input, textarea, select {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }

    button {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      background: #4b6cff;
      color: #fff;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s ease;
    }

    button:hover {
      background: #3a54d6;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .top {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .row {
      display: flex;
      gap: 8px;
    }

    .small {
      width: 120px;
    }

    .list-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      font-size: 16px;
    }

    .danger {
      background: #ff6b6b;
    }

    .back-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: linear-gradient(135deg, #5a4dff, #7a69ff);
      color: #e0e0ff;
      padding: 10px 16px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(90, 77, 255, 0.6);
      z-index: 1000;
      transition: box-shadow 0.3s ease, transform 0.15s ease;
      user-select: none;
    }

    .back-btn:hover {
      background: linear-gradient(135deg, #7a69ff, #5a4dff);
      box-shadow: 0 6px 20px rgba(122, 105, 255, 0.8);
      transform: scale(1.05);
    }

    .back-btn:focus {
      outline: 2px solid #a29bff;
      outline-offset: 3px;
      box-shadow: 0 0 10px #a29bff;
    }

    /* Estilo melhorado para a área do IP nos logs */
    .log-ip {
      font-family: monospace;
      background: #e9f0ff;
      color: #1a237e;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      user-select: text;
    }

    .log-ip svg {
      width: 16px;
      height: 16px;
      fill: #3f51b5;
      flex-shrink: 0;
    }

    /* Mobile Responsivo */
    @media (max-width: 600px) {
      body {
        padding: 12px 10px;
      }

      .card {
        padding: 14px 12px;
        margin: 12px 8px;
        max-width: 100%;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      input, textarea, select {
        font-size: 14px;
      }

      button {
        font-size: 14px;
        padding: 10px 12px;
      }

      .top {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .list-item {
        padding: 8px 6px;
        font-size: 14px;
      }

      .back-btn {
        top: 12px;
        left: 12px;
        padding: 8px 12px;
        font-size: 13px;
      }

      #musicForm > div[style*="display:flex"][style*="gap:8px"] {
        flex-direction: column;
      }

      #musicForm > div[style*="display:flex"][style*="gap:6px"] {
        flex-direction: row;
        gap: 6px;
      }

      #musicForm > div[style*="display:flex"][style*="gap:8px"]:last-child {
        flex-wrap: wrap;
      }

      #musicForm > div[style*="display:flex"][style*="gap:8px"]:last-child > button {
        flex: 1 1 100%;
        margin-bottom: 8px;
      }
    }
  </style>
</head>
<body>
  <button class="back-btn" onclick="window.location.href='/'">⬅ Voltar</button>

  <div class="card">
    <div class="top">
      <h2>Painel Admin</h2>
      <div>
        <button id="logoutBtn" style="display:none">Sair</button>
      </div>
    </div>

    <div id="loginArea">
      <h3>Login</h3>
      <form id="loginForm">
        <input name="username" placeholder="Usuário (ex: admin)" required/>
        <input name="password" placeholder="Senha" type="password" required/>
        <button type="submit">Entrar</button>
      </form>
    </div>

    <div id="adminArea" style="display:none">
      <h3>Adicionar / Editar Música</h3>
      <form id="musicForm">
        <div class="grid">
          <div>
            <label>Data (AAAA-MM-DD)</label>
            <input name="data" placeholder="2025-08-06" required/>
          </div>
          <div>
            <label>Posição (opcional — deixar vazio para adicionar ao final)</label>
            <input name="posicao" placeholder="1, 2, ..." />
          </div>
        </div>

        <input name="titulo" placeholder="Título da música"/>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="audioUrl" name="audio" placeholder="URL do arquivo .mp3 (ou faça upload abaixo)" />
          <div style="display:flex;flex-direction:column;gap:6px">
            <input id="audioFile" type="file" accept="audio/*" />
            <button id="uploadBtn" type="button">Fazer upload</button>
          </div>
        </div>

        <input name="capa" placeholder="URL da capa (opcional)"/>
        <textarea name="letra" rows="6" placeholder="Letra (opcional)"></textarea>
        <div style="display:flex;gap:8px">
          <button type="submit">Salvar</button>
          <button id="previewBtn" type="button">Preview (abrir música)</button>
        </div>
      </form>

      <hr/>
      <h4>Músicas existentes</h4>
      <div id="listaMusicas"></div>
      <hr/>
      <h4>Últimos acessos</h4>
      <div id="listaLogs"></div>
      <form id="filtro-logs">
  <label for="data">Filtrar por dia:</label>
  <input type="date" id="data" name="data">
  <button type="submit">Buscar</button>
</form>

<div id="resultado-logs"></div>

<script>
document.getElementById('filtro-logs').addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = document.getElementById('data').value;
  let url = '/api/admin/logs';
  if (data) url += `?data=${data}`;

  const res = await fetch(url);
  const logs = await res.json();

  document.getElementById('resultado-logs').innerHTML = logs.map(log => `
    <p>${log.ip} - ${log.accessed_at}</p>
  `).join('');
});
</script>

    </div>
  </div>

  <script>
    const loginForm = document.getElementById("loginForm");
    const musicForm = document.getElementById("musicForm");
    const loginArea = document.getElementById("loginArea");
    const adminArea = document.getElementById("adminArea");
    const logoutBtn = document.getElementById("logoutBtn");
    const listaMusicas = document.getElementById("listaMusicas");
    const audioFile = document.getElementById("audioFile");
    const uploadBtn = document.getElementById("uploadBtn");
    const audioUrlInput = document.getElementById("audioUrl");
    const previewBtn = document.getElementById("previewBtn");

    loginForm.onsubmit = async (e) => {
      e.preventDefault();
      const fd = new FormData(loginForm);
      const body = { username: fd.get("username"), password: fd.get("password") };
      const res = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (res.ok) {
        loginArea.style.display = "none";
        adminArea.style.display = "block";
        logoutBtn.style.display = "inline-block";
        carregarLista();
        carregarLogs();
      } else {
        const json = await res.json();
        alert(json?.error || "Erro no login");
      }
    };

    logoutBtn.onclick = async () => {
      await fetch("/api/logout", { method: "POST" });
      loginArea.style.display = "block";
      adminArea.style.display = "none";
      logoutBtn.style.display = "none";
    };

    uploadBtn.onclick = async () => {
      if (!audioFile.files || audioFile.files.length === 0) return alert("Selecione um arquivo primeiro");
      const fd = new FormData();
      fd.append("audio", audioFile.files[0]);
      uploadBtn.disabled = true;
      uploadBtn.textContent = "Enviando...";
      try {
        const res = await fetch("/api/upload", { method: "POST", body: fd });
        const json = await res.json();
        if (res.ok) {
          audioUrlInput.value = json.url;
          alert("Upload feito! URL preenchida no campo de áudio.");
        } else {
          alert(json?.error || "Erro no upload");
        }
      } catch (err) {
        alert("Erro no upload");
        console.error(err);
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = "Fazer upload";
      }
    };

    musicForm.onsubmit = async (e) => {
      e.preventDefault();
      const fd = new FormData(musicForm);
      const json = Object.fromEntries(fd.entries());
      if (!json.posicao) delete json.posicao;
      const res = await fetch("/api/musicas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(json)
      });
      if (res.ok) {
        alert("Música salva!");
        musicForm.reset();
        carregarLista();
      } else {
        const j = await res.json();
        alert(j?.error || "Erro ao salvar");
      }
    };

    previewBtn.onclick = () => {
      const url = audioUrlInput.value.trim();
      if (!url) return alert("Preencha a URL do áudio primeiro (ou faça upload).");
      window.open(url, "_blank");
    };

    async function carregarLista() {
      const res = await fetch("/api/admin/musicas");
      if (!res.ok) return;
      const rows = await res.json();
      listaMusicas.innerHTML = rows.map(r => {
        return `<div class="list-item">
          <strong>${r.data} — Pos ${r.posicao}</strong>
          <div>${r.titulo || "(sem título)"}</div>
          <div style="font-size:12px;color:#666">${r.audio || ""}</div>
          <div style="margin-top:6px">
            <button onclick="editar(${r.id})">Editar</button>
            <button onclick="deletar(${r.id})" class="danger" style="margin-left:8px;background:#ff6b6b">Deletar</button>
          </div>
        </div>`;
      }).join("");
    }

    window.editar = async (id) => {
      const res = await fetch("/api/admin/musicas");
      if (!res.ok) return alert("Erro");
      const rows = await res.json();
      const m = rows.find(x => x.id === id);
      if (!m) return alert("Não encontrado");
      musicForm.data.value = m.data;
      musicForm.posicao.value = m.posicao;
      musicForm.titulo.value = m.titulo || "";
      musicForm.audio.value = m.audio || "";
      musicForm.capa.value = m.capa || "";
      musicForm.letra.value = m.letra || "";
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    window.deletar = async (id) => {
      if (!confirm("Deseja deletar esta música?")) return;
      const res = await fetch(`/api/musicas/${id}`, { method: "DELETE" });
      if (res.ok) {
        alert("Deletado");
        carregarLista();
      } else {
        alert("Erro ao deletar");
      }
    };

    async function carregarLogs() {
      const res = await fetch("/api/admin/logs");
      if (!res.ok) return;
      const rows = await res.json();

      // Formatar a data para algo legível
      function formatarDataHora(dt) {
        const d = new Date(dt);
        return d.toLocaleString("pt-BR", {
          day: "2-digit", month: "2-digit", year: "numeric",
          hour: "2-digit", minute: "2-digit", second: "2-digit"
        });
      }

      // Função simples para limpar IP (se quiser manter o original, retire)
      function limparIP(ip) {
        return ip.trim();
      }

      listaLogs.innerHTML = rows.map(log => {
        const ipLimpo = limparIP(log.ip);
        const dataFormatada = formatarDataHora(log.accessed_at);
        return `
          <div class="list-item">
            <strong>${dataFormatada}</strong><br/>
            <div class="log-ip" title="Endereço IP">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/>
              </svg>
              ${ipLimpo}
            </div>
            <div><strong>UA:</strong> ${log.user_agent}</div>
          </div>
        `;
      }).join("");
    }
  </script>
</body>
</html>
