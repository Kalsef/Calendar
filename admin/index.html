<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <title>Painel Admin - Calendário</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      padding: 20px;
      background: #f4f6fb;
      margin: 0;
    }

    .card {
      background: #fff;
      padding: 18px;
      border-radius: 8px;
      max-width: 900px;
      margin: 20px auto;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    input, textarea, select {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }

    button {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      background: #4b6cff;
      color: #fff;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s ease;
    }

    button:hover {
      background: #3a54d6;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .top {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .row {
      display: flex;
      gap: 8px;
    }

    .small {
      width: 120px;
    }

    .list-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      font-size: 16px;
    }

    .danger {
      background: #ff6b6b;
    }

    .back-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: linear-gradient(135deg, #5a4dff, #7a69ff);
      color: #e0e0ff;
      padding: 10px 16px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(90, 77, 255, 0.6);
      z-index: 1000;
      transition: box-shadow 0.3s ease, transform 0.15s ease;
      user-select: none;
    }

    .back-btn:hover {
      background: linear-gradient(135deg, #7a69ff, #5a4dff);
      box-shadow: 0 6px 20px rgba(122, 105, 255, 0.8);
      transform: scale(1.05);
    }

    .back-btn:focus {
      outline: 2px solid #a29bff;
      outline-offset: 3px;
      box-shadow: 0 0 10px #a29bff;
    }

    /* Mobile Responsivo */
    @media (max-width: 600px) {
      body {
        padding: 12px 10px;
      }

      .card {
        padding: 14px 12px;
        margin: 12px 8px;
        max-width: 100%;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      input, textarea, select {
        font-size: 14px;
      }

      button {
        font-size: 14px;
        padding: 10px 12px;
      }

      .top {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .list-item {
        padding: 8px 6px;
        font-size: 14px;
      }

      .back-btn {
        top: 12px;
        left: 12px;
        padding: 8px 12px;
        font-size: 13px;
      }

      #musicForm > div[style*="display:flex"][style*="gap:8px"] {
        flex-direction: column;
      }

      #musicForm > div[style*="display:flex"][style*="gap:6px"] {
        flex-direction: row;
        gap: 6px;
      }

      #musicForm > div[style*="display:flex"][style*="gap:8px"]:last-child {
        flex-wrap: wrap;
      }

      #musicForm > div[style*="display:flex"][style*="gap:8px"]:last-child > button {
        flex: 1 1 100%;
        margin-bottom: 8px;
      }
    }
  </style>
</head>
<body>
  <button class="back-btn" onclick="window.location.href='/'">⬅ Voltar</button>

  <div class="card">
    <div class="top">
      <h2>Painel Admin</h2>
      <div>
        <button id="logoutBtn" style="display:none">Sair</button>
      </div>
    </div>

    <div id="loginArea">
      <h3>Login</h3>
      <form id="loginForm">
        <input name="username" placeholder="Usuário (ex: admin)" required/>
        <input name="password" placeholder="Senha" type="password" required/>
        <button type="submit">Entrar</button>
      </form>
    </div>

    <div id="adminArea" style="display:none">
      <h3>Adicionar / Editar Música</h3>
      <form id="musicForm">
        <div class="grid">
          <div>
            <label>Data (AAAA-MM-DD)</label>
            <input name="data" placeholder="2025-08-06" required/>
          </div>
          <div>
            <label>Posição (opcional — deixar vazio para adicionar ao final)</label>
            <input name="posicao" placeholder="1, 2, ..." />
          </div>
        </div>

        <input name="titulo" placeholder="Título da música"/>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="audioUrl" name="audio" placeholder="URL do arquivo .mp3 (ou faça upload abaixo)" />
          <div style="display:flex;flex-direction:column;gap:6px">
            <input id="audioFile" type="file" accept="audio/*" />
            <button id="uploadBtn" type="button">Fazer upload</button>
          </div>
        </div>

        <input name="capa" placeholder="URL da capa (opcional)"/>
        <textarea name="letra" rows="6" placeholder="Letra (opcional)"></textarea>
        <div style="display:flex;gap:8px">
          <button type="submit">Salvar</button>
          <button id="previewBtn" type="button">Preview (abrir música)</button>
        </div>
      </form>

      <hr/>
      <h4>Músicas existentes</h4>
      <div id="listaMusicas"></div>
      <hr/>
      <h4>Últimos acessos</h4>
      <div id="listaLogs"></div>
    </div>
  </div>

  <script>
    const loginForm = document.getElementById("loginForm");
    const musicForm = document.getElementById("musicForm");
    const loginArea = document.getElementById("loginArea");
    const adminArea = document.getElementById("adminArea");
    const logoutBtn = document.getElementById("logoutBtn");
    const listaMusicas = document.getElementById("listaMusicas");
    const audioFile = document.getElementById("audioFile");
    const uploadBtn = document.getElementById("uploadBtn");
    const audioUrlInput = document.getElementById("audioUrl");
    const previewBtn = document.getElementById("previewBtn");
    const listaLogs = document.getElementById("listaLogs");

    // Formatação data/hora legível
    function formatarDataHora(isoString) {
      const data = new Date(isoString);
      return data.toLocaleString('pt-BR', {
        dateStyle: 'short',
        timeStyle: 'medium',
      });
    }

    // Limpa IP, pega só o primeiro (no caso de IPs múltiplos)
    function limparIP(ipString) {
      return ipString ? ipString.split(',')[0].trim() : '';
    }

    // Resume user agent para navegador + sistema operacional básico
    function resumirUserAgent(ua) {
      const navegadores = ['Chrome', 'Firefox', 'Safari', 'Edge', 'Opera', 'MSIE', 'Trident'];
      let navegadorEncontrado = navegadores.find(nav => ua.includes(nav)) || 'Desconhecido';

      let so = 'Desconhecido';
      if (ua.includes('Windows NT 10')) so = 'Windows 10';
      else if (ua.includes('Windows NT 6.1')) so = 'Windows 7';
      else if (ua.includes('Macintosh')) so = 'Mac OS';
      else if (ua.includes('Linux')) so = 'Linux';
      else if (ua.includes('Android')) so = 'Android';
      else if (ua.includes('iPhone')) so = 'iOS';

      return `${navegadorEncontrado} / ${so}`;
    }

    // Busca localização do IP via API pública ip-api.com
    async function buscarLocalizacao(ip) {
      try {
        const res = await fetch(`https://ip-api.com/json/${ip}?lang=pt`);
        if (!res.ok) return '';
        const data = await res.json();
        if (data.status === 'success') {
          return `${data.city || ''}, ${data.regionName || ''}, ${data.country || ''}`.replace(/^(, )+|(, )+$/g, '');
        }
      } catch {
        return '';
      }
      return '';
    }

    // Paginação dos logs
    let paginaAtual = 1;
    const logsPorPagina = 20;
    let logsCache = [];

    async function carregarLogs(pagina = 1) {
      const res = await fetch("/api/admin/logs");
      if (!res.ok) return;
      logsCache = await res.json();

      paginaAtual = pagina;
      mostrarPaginaLogs(paginaAtual);
    }

    async function mostrarPaginaLogs(pagina) {
      const start = (pagina - 1) * logsPorPagina;
      const end = start + logsPorPagina;
      const logsPagina = logsCache.slice(start, end);

      const lista = await Promise.all(logsPagina.map(async log => {
        const ipLimpo = limparIP(log.ip);
        const localizacao = await buscarLocalizacao(ipLimpo);
        return `
          <div class="list-item">
            <strong>${formatarDataHora(log.accessed_at)}</strong><br/>
            IP: ${ipLimpo} ${localizacao ? ` — ${localizacao}` : ''}<br/>
            Navegador/SO: ${resumirUserAgent(log.user_agent)}
          </div>
        `;
      }));

      listaLogs.innerHTML = lista.join('') + paginacaoHTML();
    }

    function paginacaoHTML() {
      const totalPaginas = Math.ceil(logsCache.length / logsPorPagina);
      if (totalPaginas <= 1) return '';

      let html = `<div style="margin-top:12px; display:flex; justify-content:center; gap:10px;">`;

      if (paginaAtual > 1) {
        html += `<button onclick="mostrarPaginaLogs(${paginaAtual - 1})">⬅ Anterior</button>`;
      } else {
        html += `<button disabled style="opacity:0.4;cursor:default;">⬅ Anterior</button>`;
      }

      html += `<span style="padding:0 8px; line-height:32px;">Página ${paginaAtual} de ${totalPaginas}</span>`;

      if (paginaAtual < totalPaginas) {
        html += `<button onclick="mostrarPaginaLogs(${paginaAtual + 1})">Próximo ➡</button>`;
      } else {
        html += `<button disabled style="opacity:0.4;cursor:default;">Próximo ➡</button>`;
      }

      html += `</div>`;
      return html;
    }

    // Login
    loginForm.onsubmit = async (e) => {
      e.preventDefault();
      const fd = new FormData(loginForm);
      const body = { username: fd.get("username"), password: fd.get("password") };
      const res = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (res.ok) {
        loginArea.style.display = "none";
        adminArea.style.display = "block";
        logoutBtn.style.display = "inline-block";
        carregarLista();
        carregarLogs(1);
      } else {
        const json = await res.json();
        alert(json?.error || "Erro no login");
      }
    };

    // Logout
    logoutBtn.onclick = async () => {
      await fetch("/api/logout");
      location.reload();
    };

    // Carregar lista de músicas
    async function carregarLista() {
      const res = await fetch("/api/admin");
      if (!res.ok) return;
      const dados = await res.json();

      listaMusicas.innerHTML = dados
        .map((m, i) => {
          const capa = m.capa ? `<img src="${m.capa}" style="max-height:40px; vertical-align:middle; margin-right:8px; border-radius:4px;"/>` : '';
          const letra = m.letra ? `<pre style="white-space: pre-wrap; font-size:14px; margin-top:6px;">${m.letra}</pre>` : '';
          return `<div class="list-item" style="border-radius:8px; border: 1px solid #ddd; margin-bottom:8px; padding:8px;">
            <strong>${i + 1}. ${capa}${m.titulo}</strong>
            ${letra}
            <br/>
            <audio controls style="width:100%; max-width:300px;">
              <source src="${m.audio}" type="audio/mpeg"/>
              Seu navegador não suporta áudio.
            </audio>
          </div>`;
        })
        .join("");
    }

    // Upload do arquivo de áudio
    uploadBtn.onclick = async () => {
      if (!audioFile.files.length) {
        alert("Selecione um arquivo para upload!");
        return;
      }
      const file = audioFile.files[0];
      const formData = new FormData();
      formData.append("audio", file);

      uploadBtn.disabled = true;
      uploadBtn.textContent = "Enviando...";
      try {
        const res = await fetch("/api/upload", { method: "POST", body: formData });
        if (!res.ok) throw new Error("Upload falhou");
        const json = await res.json();
        audioUrlInput.value = json.url;
        alert("Upload realizado com sucesso!");
      } catch {
        alert("Falha ao enviar arquivo!");
      }
      uploadBtn.disabled = false;
      uploadBtn.textContent = "Fazer upload";
    };

    // Salvar música (adicionar/editar)
    musicForm.onsubmit = async (e) => {
      e.preventDefault();
      const fd = new FormData(musicForm);
      const body = {
        data: fd.get("data"),
        posicao: fd.get("posicao"),
        titulo: fd.get("titulo"),
        audio: fd.get("audio"),
        capa: fd.get("capa"),
        letra: fd.get("letra"),
      };
      const res = await fetch("/api/admin", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      if (res.ok) {
        alert("Música salva com sucesso!");
        carregarLista();
        musicForm.reset();
      } else {
        alert("Erro ao salvar música.");
      }
    };

    // Preview música
    previewBtn.onclick = () => {
      const url = audioUrlInput.value.trim();
      if (!url) {
        alert("Coloque a URL do arquivo de áudio para preview.");
        return;
      }
      window.open(url, "_blank");
    };
  </script>
</body>
</html>
