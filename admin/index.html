<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Painel de Músicas</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    background: #f5f5f5;
  }
  .container {
    max-width: 900px;
    margin: auto;
    padding: 20px;
    background: white;
  }
  h1, h2 {
    margin-top: 0;
  }
  form input, form select, form textarea, button {
    width: 100%;
    padding: 8px;
    margin: 4px 0;
    box-sizing: border-box;
  }
  .grid {
    display: flex;
    gap: 8px;
  }
  .list-item {
    border: 1px solid #ddd;
    padding: 10px;
    margin-top: 8px;
    border-radius: 6px;
    background: #fafafa;
  }
  .danger {
    background: #ff6b6b;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
  }
  /* Estilo para IPs */
  .log-ip {
    font-family: monospace;
    padding: 4px 8px;
    border-radius: 6px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
    cursor: pointer;
    user-select: text;
    transition: background 0.2s ease;
  }
  .log-ip.ipv4 {
    background: #e9f0ff;
    color: #1a237e;
  }
  .log-ip.ipv6 {
    background: #eafaea;
    color: #1b5e20;
  }
  .log-ip:hover {
    background: #d0d8ff;
  }
  .log-ip svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
  }
  @media(max-width:600px){
    .grid { flex-direction: column; }
  }
</style>
</head>
<body>
<div class="container">

  <h1>Painel de Músicas</h1>

  <form id="musicForm">
    <input type="hidden" name="id" />
    <div class="grid">
      <div>
        <label>Data</label>
        <input type="date" name="data" required />
      </div>
      <div>
        <label>Posição</label>
        <input name="posicao" placeholder="1, 2, ..." />
      </div>
    </div>
    <input name="titulo" placeholder="Título da música" />
    <div style="display:flex;gap:8px;align-items:center">
      <input id="audioUrl" name="audio" placeholder="URL do arquivo .mp3" />
      <div style="display:flex;flex-direction:column;gap:6px;width:150px">
        <input id="audioFile" type="file" accept="audio/*" />
        <button id="uploadBtn" type="button">Fazer upload</button>
        <progress id="uploadProgress" value="0" max="100" style="width:100%;display:none"></progress>
      </div>
    </div>
    <input name="capa" placeholder="URL da capa (opcional)" />
    <textarea name="letra" rows="6" placeholder="Letra (opcional)"></textarea>
    <div style="display:flex;gap:8px">
      <button type="submit" id="saveBtn">Salvar</button>
      <button id="cancelEditBtn" type="button" style="display:none;background:#999;color:white">Cancelar edição</button>
    </div>
  </form>

  <h2>Lista de músicas</h2>
  <div id="listaMusicas"></div>

  <h2>Logs de acesso</h2>
  <div id="listaLogs"></div>

</div>

<script>
  const musicForm = document.getElementById("musicForm");
  const saveBtn = document.getElementById("saveBtn");
  const cancelEditBtn = document.getElementById("cancelEditBtn");
  const uploadBtn = document.getElementById("uploadBtn");
  const audioFile = document.getElementById("audioFile");
  const audioUrlInput = document.getElementById("audioUrl");
  const uploadProgress = document.getElementById("uploadProgress");
  const listaMusicas = document.getElementById("listaMusicas");
  const listaLogs = document.getElementById("listaLogs");

  cancelEditBtn.onclick = () => {
    musicForm.reset();
    musicForm.id.value = "";
    saveBtn.textContent = "Salvar";
    saveBtn.style.background = "";
    cancelEditBtn.style.display = "none";
  };

  musicForm.onsubmit = async (e) => {
    e.preventDefault();
    const fd = new FormData(musicForm);
    const json = Object.fromEntries(fd.entries());
    if (!json.posicao) delete json.posicao;

    const url = json.id ? `/api/musicas/${json.id}` : "/api/musicas";
    const method = json.id ? "PUT" : "POST";

    const res = await fetch(url, {
      method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(json)
    });

    if (res.ok) {
      alert(json.id ? "Música atualizada!" : "Música salva!");
      cancelEditBtn.onclick();
      carregarLista();
    } else {
      const j = await res.json();
      alert(j?.error || "Erro ao salvar");
    }
  };

  uploadBtn.onclick = () => {
    if (!audioFile.files || audioFile.files.length === 0) {
      alert("Selecione um arquivo primeiro");
      return;
    }

    const file = audioFile.files[0];
    const fd = new FormData();
    fd.append("audio", file);

    const xhr = new XMLHttpRequest();
    xhr.open("POST", "/api/upload", true);

    uploadBtn.disabled = true;
    uploadBtn.textContent = "Enviando...";
    uploadProgress.style.display = "block";
    uploadProgress.value = 0;

    xhr.upload.onprogress = (event) => {
      if (event.lengthComputable) {
        const percent = Math.round((event.loaded / event.total) * 100);
        uploadProgress.value = percent;
        uploadBtn.textContent = `Enviando... ${percent}%`;
      }
    };

    xhr.onload = () => {
      uploadBtn.disabled = false;
      uploadBtn.textContent = "Fazer upload";
      uploadProgress.style.display = "none";

      try {
        const res = JSON.parse(xhr.responseText);
        if (xhr.status === 200) {
          audioUrlInput.value = res.url;
          alert("Upload feito! URL preenchida.");
        } else {
          alert(res?.error || "Erro no upload");
        }
      } catch {
        alert("Erro no upload");
      }
    };

    xhr.onerror = () => {
      uploadBtn.disabled = false;
      uploadBtn.textContent = "Fazer upload";
      uploadProgress.style.display = "none";
      alert("Erro na conexão durante o upload.");
    };

    xhr.send(fd);
  };

  window.editar = async (id) => {
    const res = await fetch("/api/admin/musicas");
    if (!res.ok) return alert("Erro");
    const rows = await res.json();
    const m = rows.find(x => x.id === id);
    if (!m) return alert("Não encontrado");

    musicForm.id.value = m.id;
    musicForm.data.value = m.data;
    musicForm.posicao.value = m.posicao;
    musicForm.titulo.value = m.titulo || "";
    musicForm.audio.value = m.audio || "";
    musicForm.capa.value = m.capa || "";
    musicForm.letra.value = m.letra || "";

    saveBtn.textContent = "Atualizar";
    saveBtn.style.background = "#ffa500";
    cancelEditBtn.style.display = "inline-block";
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  window.deletar = async (id) => {
    if (!confirm("Deseja deletar esta música?")) return;
    const res = await fetch(`/api/musicas/${id}`, { method: "DELETE" });
    if (res.ok) {
      alert("Deletado!");
      carregarLista();
    } else {
      alert("Erro ao deletar");
    }
  };

  function getIPClass(ip) {
    return ip.includes(":") ? "ipv6" : "ipv4";
  }

  async function copiarIP(ip) {
    try {
      await navigator.clipboard.writeText(ip);
      alert("IP copiado: " + ip);
    } catch {
      alert("Não foi possível copiar.");
    }
  }

  async function carregarLista() {
    const res = await fetch("/api/admin/musicas");
    if (!res.ok) return;
    const rows = await res.json();
    listaMusicas.innerHTML = rows.map(r => `
      <div class="list-item">
        <strong>${r.data} — Pos ${r.posicao}</strong>
        <div>${r.titulo || "(sem título)"}</div>
        ${r.audio ? `<audio controls src="${r.audio}" style="width:100%;margin-top:6px"></audio>` : ""}
        <div style="margin-top:6px">
          <button onclick="editar(${r.id})">Editar</button>
          <button onclick="deletar(${r.id})" class="danger">Deletar</button>
        </div>
      </div>
    `).join("");
  }

  async function carregarLogs() {
    const res = await fetch("/api/admin/logs");
    if (!res.ok) return;
    const rows = await res.json();
    listaLogs.innerHTML = rows.map(log => `
      <div class="list-item">
        <strong>${new Date(log.accessed_at).toLocaleString("pt-BR")}</strong><br/>
        <div class="log-ip ${getIPClass(log.ip)}" title="Clique para copiar" onclick="copiarIP('${log.ip}')">
          <svg viewBox="0 0 24 24">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/>
          </svg>
          ${log.ip}
        </div>
        <div><strong>UA:</strong> ${log.user_agent}</div>
      </div>
    `).join("");
  }

  carregarLista();
  carregarLogs();
</script>
</body>
</html>
