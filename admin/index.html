<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calendário de Músicas</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 8px; text-align: center; vertical-align: top; }
  th { background-color: #f3f4f6; }
  td { border: 1px solid #e5e7eb; min-height: 100px; }
  .calendar-day { position: relative; }
  .calendar-day strong { display: block; margin-bottom: 5px; }
  .music-card {
    background: #ffffff;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-bottom: 5px;
    padding: 5px;
    font-size: 0.85rem;
  }
  .music-card button {
    margin-top: 3px;
    margin-right: 3px;
    font-size: 0.75rem;
    padding: 3px 6px;
  }
  .weekend { background-color: #fef3c7; }
  @media(max-width:768px){
    table, th, td { font-size: 0.75rem; }
    .music-card audio { width: 100%; }
  }
  .primary { background-color: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; }
  .danger { background-color: #ef4444; color: white; border: none; border-radius: 5px; cursor: pointer; }
</style>
</head>
<body>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
  <button id="prevMonth" class="primary">◀ Anterior</button>
  <h4 id="monthYear"></h4>
  <button id="nextMonth" class="primary">Próximo ▶</button>
</div>

<div id="calendarContainer"></div>

<script>
let currentDate = new Date();

document.getElementById("prevMonth").onclick = () => {
  currentDate.setMonth(currentDate.getMonth() - 1);
  carregarLista();
};
document.getElementById("nextMonth").onclick = () => {
  currentDate.setMonth(currentDate.getMonth() + 1);
  carregarLista();
};

async function carregarLista() {
  const res = await fetch("/api/admin/musicas");
  const container = document.getElementById("calendarContainer");
  if(!res.ok){
    container.innerHTML = "Erro ao carregar músicas";
    return;
  }

  const musics = await res.json();
  const musicByDate = {};
  musics.forEach(m => {
    if(!musicByDate[m.data]) musicByDate[m.data]=[];
    musicByDate[m.data].push(m);
  });

  const ano = currentDate.getFullYear();
  const mes = currentDate.getMonth();
  const primeiroDia = new Date(ano, mes, 1);
  const ultimoDia = new Date(ano, mes+1, 0);
  const diasNoMes = ultimoDia.getDate();

  const meses = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho",
                 "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
  document.getElementById("monthYear").innerText = `${meses[mes]} ${ano}`;

  let html = `<table><thead><tr>`;
  const diasSemana=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
  diasSemana.forEach(d => html+=`<th>${d}</th>`);
  html += `</tr></thead><tbody><tr>`;

  for(let i=0;i<primeiroDia.getDay();i++) html+=`<td></td>`;

  for(let dia=1; dia<=diasNoMes; dia++){
    const dateStr = `${ano}-${String(mes+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;
    const isToday = new Date().toDateString() === new Date(ano, mes, dia).toDateString();
    const isWeekend = [0,6].includes(new Date(ano, mes, dia).getDay());
    
    html += `<td class="calendar-day ${isWeekend ? 'weekend' : ''}" style="${isToday ? 'background:#e0f2fe; border:2px solid #3b82f6;' : ''}">
      <strong>${dia}</strong>`;
    
    if(musicByDate[dateStr]){
      musicByDate[dateStr].forEach(m=>{
        html+=`<div class="music-card">
          <strong>${m.titulo}</strong>
          <audio controls src="${m.audio}"></audio>
          <div>
            <button class="primary" onclick="editar(${m.id})">Editar</button>
            <button class="danger" onclick="deletar(${m.id})">Deletar</button>
          </div>
        </div>`;
      });
    }
    html += `</td>`;
    if((dia + primeiroDia.getDay()) % 7 === 0) html += `</tr><tr>`;
  }

  const totalCells = diasNoMes + primeiroDia.getDay();
  const restante = 7-(totalCells%7);
  if(restante<7) for(let i=0;i<restante;i++) html+=`<td></td>`;

  html += `</tr></tbody></table>`;
  container.innerHTML = html;
}

function editar(id){ alert("Editar música ID: " + id); }
function deletar(id){ alert("Deletar música ID: " + id); }

carregarLista();
</script>

</body>
</html>
