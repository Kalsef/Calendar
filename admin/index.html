<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <title>Painel Admin - Calendário</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    /* Reset e fontes */
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #f3f4f6;
      color: #111827;
    }
    button, input, textarea {
      font-family: inherit;
    }

    /* Container */
    .container {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 1.5rem;
      background: #fff;
      border-radius: 0.75rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    h2, h3, h4 {
      margin: 0.5rem 0;
    }

    /* Inputs e botões */
    input, textarea, select {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      margin-top: 0.25rem;
      margin-bottom: 0.75rem;
      font-size: 1rem;
    }

    button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }

    button.primary {
      background-color: #4f46e5;
      color: white;
    }
    button.primary:hover {
      background-color: #4338ca;
    }

    button.warning {
      background-color: #f59e0b;
      color: white;
    }
    button.warning:hover {
      background-color: #d97706;
    }

    button.danger {
      background-color: #ef4444;
      color: white;
    }
    button.danger:hover {
      background-color: #b91c1c;
    }

    button.cancel {
      background-color: #9ca3af;
      color: white;
    }

    /* Grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
    }

    /* Botão voltar */
    .back-btn {
      position: fixed;
      top: 1rem;
      left: 1rem;
      background: linear-gradient(135deg, #6366f1, #818cf8);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 12px rgba(99,102,241,0.5);
      border: none;
      cursor: pointer;
      z-index: 1000;
      transition: all 0.2s;
    }
    .back-btn:hover {
      transform: scale(1.05);
    }

    /* Progress */
    progress {
      width: 100%;
      height: 0.75rem;
      border-radius: 0.375rem;
      overflow: hidden;
      margin-top: 0.25rem;
      margin-bottom: 0.5rem;
    }

    /* Calendário */
    #calendarContainer table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      margin-top: 1rem;
    }
    #calendarContainer th, #calendarContainer td {
      border: 1px solid #d1d5db;
      padding: 0.25rem;
      vertical-align: top;
    }
    #calendarContainer th {
      background: #e5e7eb;
      text-align: center;
    }
    .calendar-day {
      min-height: 100px;
      padding: 0.25rem;
      border-radius: 0.25rem;
    }
    .music-card {
      margin-top: 0.25rem;
      padding: 0.25rem;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: #f9fafb;
    }
    .music-card strong {
      display:block;
      margin-bottom:0.25rem;
    }
    .music-card button {
      margin-top:0.25rem;
      margin-right:0.25rem;
    }

    /* Mobile */
    @media(max-width: 640px){
      .grid { grid-template-columns: 1fr; }
      #calendarContainer table, #calendarContainer th, #calendarContainer td {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <button class="back-btn" onclick="window.location.href='/'">⬅ Voltar</button>

  <div class="container">
    <div id="loginArea">
      <h3>Login</h3>
      <form id="loginForm">
        <input name="username" placeholder="Usuário" required/>
        <input name="password" type="password" placeholder="Senha" required/>
        <button type="submit" class="primary">Entrar</button>
      </form>
    </div>

    <div id="adminArea" style="display:none">
      <div class="top" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
        <h2>Painel Admin</h2>
        <button id="logoutBtn" class="primary" style="display:none">Sair</button>
      </div>

      <h3>Adicionar / Editar Música</h3>
      <form id="musicForm">
        <input type="hidden" name="id" />
        <div class="grid">
          <div>
            <label>Data</label>
            <input type="date" name="data" required />
          </div>
          <div>
            <label>Posição</label>
            <input name="posicao" placeholder="1, 2, ..." />
          </div>
        </div>
        <input name="titulo" placeholder="Título da música"/>
        <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
          <input id="audioUrl" name="audio" placeholder="URL do arquivo .mp3" style="flex:1"/>
          <div style="display:flex; flex-direction:column; gap:0.5rem; width:150px;">
            <input id="audioFile" type="file" accept="audio/*" />
            <button id="uploadBtn" type="button" class="primary">Upload</button>
            <progress id="uploadProgress" value="0" max="100" style="display:none;"></progress>
          </div>
        </div>
        <input name="capa" placeholder="URL da capa (opcional)"/>
        <textarea name="letra" rows="6" placeholder="Letra (opcional)"></textarea>
        <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
          <button type="submit" id="saveBtn" class="primary">Salvar</button>
          <button id="cancelEditBtn" type="button" class="cancel" style="display:none;">Cancelar</button>
          <button id="previewBtn" type="button" class="warning">Preview</button>
        </div>
      </form>

      <hr style="margin:1rem 0"/>
      <h4>Músicas existentes</h4>
      <div id="calendarContainer"></div>

      <hr style="margin:1rem 0"/>
      <h4>Últimos acessos</h4>
      <div id="listaLogs"></div>
    </div>
  </div>

  <script>
    const loginForm = document.getElementById("loginForm");
    const musicForm = document.getElementById("musicForm");
    const loginArea = document.getElementById("loginArea");
    const adminArea = document.getElementById("adminArea");
    const logoutBtn = document.getElementById("logoutBtn");
    const audioFile = document.getElementById("audioFile");
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadProgress = document.getElementById("uploadProgress");
    const audioUrlInput = document.getElementById("audioUrl");
    const previewBtn = document.getElementById("previewBtn");
    const saveBtn = document.getElementById("saveBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");

    // Login
    loginForm.onsubmit = async (e) => {
      e.preventDefault();
      const fd = new FormData(loginForm);
      const body = { username: fd.get("username"), password: fd.get("password") };
      const res = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if(res.ok){
        loginArea.style.display="none";
        adminArea.style.display="block";
        logoutBtn.style.display="inline-block";
        carregarLista();
      } else {
        alert("Login falhou!");
      }
    }

    logoutBtn.onclick = () => location.reload();

    // Upload
    uploadBtn.onclick = async ()=>{
      if(!audioFile.files.length) return alert("Selecione um arquivo");
      const fd = new FormData();
      fd.append("file", audioFile.files[0]);
      uploadProgress.style.display="block";
      const xhr = new XMLHttpRequest();
      xhr.open("POST","/api/upload");
      xhr.upload.onprogress = (e) => {
        uploadProgress.value = (e.loaded/e.total)*100;
      }
      xhr.onload = () => {
        if(xhr.status===200){
          const data = JSON.parse(xhr.responseText);
          audioUrlInput.value = data.url;
        } else alert("Erro no upload");
        uploadProgress.style.display="none";
      }
      xhr.send(fd);
    }

    // Preview
    previewBtn.onclick = ()=>{
      const url = audioUrlInput.value;
      if(!url) return alert("Insira URL de áudio");
      const win = window.open("", "_blank");
      win.document.write(`<audio controls autoplay src="${url}" style="width:100%"></audio>`);
    }

    // CRUD
    musicForm.onsubmit = async (e)=>{
      e.preventDefault();
      const fd = new FormData(musicForm);
      const data = {};
      for(const [k,v] of fd.entries()) data[k]=v;
      const id = data.id;
      const method = id ? "PUT" : "POST";
      const url = id ? `/api/admin/musicas/${id}` : "/api/admin/musicas";
      const res = await fetch(url,{
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      if(res.ok){
        musicForm.reset();
        cancelEditBtn.style.display="none";
        carregarLista();
      } else alert("Erro ao salvar");
    }

    cancelEditBtn.onclick = ()=>{
      musicForm.reset();
      cancelEditBtn.style.display="none";
    }

    async function editar(id){
      const res = await fetch(`/api/admin/musicas/${id}`);
      if(!res.ok) return alert("Erro ao buscar música");
      const m = await res.json();
      for(const key in m) if(musicForm[key]) musicForm[key].value = m[key];
      cancelEditBtn.style.display="inline-block";
      window.scrollTo({top:0,behavior:"smooth"});
    }

    async function deletar(id){
      if(!confirm("Deseja realmente deletar?")) return;
      const res = await fetch(`/api/admin/musicas/${id}`,{method:"DELETE"});
      if(res.ok) carregarLista();
      else alert("Erro ao deletar");
    }

    // Função principal: calendário
    async function carregarLista(){
      const res = await fetch("/api/admin/musicas");
      const container = document.getElementById("calendarContainer");
      if(!res.ok){
        container.innerHTML = "Erro ao carregar músicas";
        return;
      }
      const musics = await res.json();
      const musicByDate = {};
      musics.forEach(m => {
        if(!musicByDate[m.data]) musicByDate[m.data]=[];
        musicByDate[m.data].push(m);
      });

      const hoje = new Date();
      const ano = hoje.getFullYear();
      const mes = hoje.getMonth();
      const primeiroDia = new Date(ano, mes, 1);
      const ultimoDia = new Date(ano, mes+1,0);
      const diasNoMes = ultimoDia.getDate();

      let html = `<table><thead><tr>`;
      const diasSemana=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
      diasSemana.forEach(d => html+=`<th>${d}</th>`);
      html += `</tr></thead><tbody><tr>`;

      for(let i=0;i<primeiroDia.getDay();i++) html+=`<td></td>`;

      for(let dia=1; dia<=diasNoMes; dia++){
        const dateStr = `${ano}-${String(mes+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;
        html += `<td class="calendar-day"><strong>${dia}</strong>`;
        if(musicByDate[dateStr]){
          musicByDate[dateStr].forEach(m=>{
            html+=`<div class="music-card">
              <strong>${m.titulo}</strong>
              <audio controls src="${m.audio}" style="width:100%"></audio>
              <div>
                <button class="primary" onclick="editar(${m.id})">Editar</button>
                <button class="danger" onclick="deletar(${m.id})">Deletar</button>
              </div>
            </div>`;
          });
        }
        html += `</td>`;
        if((dia+primeiroDia.getDay())%7===0) html+=`</tr><tr>`;
      }

      const totalCells = diasNoMes + primeiroDia.getDay();
      const restante = 7-(totalCells%7);
      if(restante<7) for(let i=0;i<restante;i++) html+=`<td></td>`;

      html += `</tr></tbody></table>`;
      container.innerHTML = html;
    }
  </script>
</body>
</html>
